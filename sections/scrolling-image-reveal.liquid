{% comment %}
  Scrolling Image Reveal Section
  - OS 2.0 compatible
  - IntersectionObserver + CSS clip/opacity
{% endcomment %}

<section id="sir-{{ section.id }}" class="sir">
  <!-- 粘性舞台容器 -->
  <div class="sir-stage">
    {% for block in section.blocks %}
      {% liquid
        assign img = block.settings.image
        assign has_button = false
        if block.settings.button_label != blank and block.settings.button_link != blank
          assign has_button = true
        endif
        assign card_index = forloop.index0
      %}
      <article class="sir-card" data-card-index="{{ card_index }}" {{ block.shopify_attributes }}>
        <div class="sir-card__media">
          {% if block.type == 'video' %}
            {% liquid
              assign video = block.settings.video
            %}
            {% if video %}
              {{- 
                video | video_tag: 
                  class: "sir-card__video",
                  image_size: 900, 
                  autoplay: block.settings.autoplay, 
                  loop: block.settings.loop, 
                  muted: block.settings.muted, 
                  controls: block.settings.controls,
                  preload: "metadata",
                  width: "100%",
                  height: "auto"
              -}}
            {% endif %}
          {% else %}
            {% if img %}
              {{
                img
                | image_url: width: 1600
                | image_tag:
                  loading: 'lazy',
                  widths: '480,720,960,1200,1600,2000',
                  sizes: '(min-width: 1200px) 1100px, 100vw',
                  alt: block.settings.image_alt
                | escape
              }}
            {% endif %}
          {% endif %}
        </div>
        <div class="sir-card__copy">
          {% if block.settings.heading != blank %}
            <h3 class="sir-card__title">{{ block.settings.heading | escape }}</h3>
          {% endif %}
          {% if block.settings.text != blank %}
            <p class="sir-card__text">{{ block.settings.text }}</p>
          {% endif %}
          {% if has_button %}
            <a class="sir-card__btn" href="{{ block.settings.button_link }}">
              {{- block.settings.button_label | escape -}}
            </a>
          {% endif %}
        </div>
      </article>
    {% endfor %}
  </div>

  <!-- 引入外部CSS文件 -->
  {{ 'scrolling-image-reveal.css' | asset_url | stylesheet_tag }}
  
  <!-- 动态CSS变量 -->
  <style>
    #sir-{{ section.id }} {
      --sir-reveal-duration: {{ section.settings.reveal_duration | default: 700 }}ms;
      --sir-stagger: {{ section.settings.stagger | default: 120 }}ms;
      --sir-blur: {{ section.settings.bg_blur | default: 0 }}px;
      height: calc(var(--sir-stage-height) * {{ section.blocks.size | default: 3 }});
    }
  </style>

  <!-- 引入外部JavaScript文件 -->
  <script src="{{ 'scrolling-image-reveal.js' | asset_url }}" defer></script>

  {% schema %}
{
  "name": "Scrolling image reveal",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "range",
      "id": "bg_blur",
      "label": "背景模糊强度",
      "unit": "px",
      "min": 0,
      "max": 20,
      "step": 1,
      "default": 6
    },
    {
      "type": "range",
      "id": "reveal_duration",
      "label": "揭示动画时长",
      "unit": "ms",
      "min": 200,
      "max": 1500,
      "step": 50,
      "default": 700
    },
    {
      "type": "range",
      "id": "stagger",
      "label": "文案交错延迟",
      "unit": "ms",
      "min": 0,
      "max": 400,
      "step": 20,
      "default": 120
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "卡片",
      "settings": [
        { "type": "image_picker", "id": "image", "label": "图片" },
        { "type": "text", "id": "image_alt", "label": "图片替代文本 (alt)" },
        { "type": "text", "id": "heading", "label": "标题", "default": "逐条揭示的卖点标题" },
        { "type": "textarea", "id": "text", "label": "正文", "default": "简短的一句话说明，突出价值点与关键信息。" },
        { "type": "text", "id": "button_label", "label": "按钮文本" },
        { "type": "url", "id": "button_link", "label": "按钮链接" },
        {
          "type": "range",
          "id": "parallax_speed",
          "label": "视差强度（0=关闭）",
          "min": 0,
          "max": 1,
          "step": 0.1,
          "default": 0.2
        }
      ]
    },
    {
      "type": "video",
      "name": "视频卡片",
      "settings": [
        { "type": "video", "id": "video", "label": "视频文件" },
        { "type": "text", "id": "video_alt", "label": "视频替代文本 (alt)" },
        { "type": "text", "id": "heading", "label": "标题", "default": "视频标题" },
        { "type": "textarea", "id": "text", "label": "正文", "default": "视频描述内容。" },
        { "type": "text", "id": "button_label", "label": "按钮文本" },
        { "type": "url", "id": "button_link", "label": "按钮链接" },
        { "type": "checkbox", "id": "autoplay", "label": "自动播放", "default": true },
        { "type": "checkbox", "id": "loop", "label": "循环播放", "default": true },
        { "type": "checkbox", "id": "muted", "label": "静音播放", "default": true },
        { "type": "checkbox", "id": "controls", "label": "显示控制条", "default": false },
        {
          "type": "range",
          "id": "parallax_speed",
          "label": "视差强度（0=关闭）",
          "min": 0,
          "max": 1,
          "step": 0.1,
          "default": 0.2
        }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    { 
      "name": "Scrolling image reveal", 
      "category": "Image",
      "blocks": [
        { "type": "card" },
        { "type": "video" },
        { "type": "card" }
      ]
    }
  ]
}
  {% endschema %}
</section>
